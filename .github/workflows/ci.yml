name: CI/CD Pipeline

on:
  push:
    branches: [main, develop, production]
  pull_request:
    branches: [main, develop, production]
    types: [opened, synchronize, reopened]

jobs:
  quality-check:
    name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ESLint ê²€ì‚¬
        run: npm run lint

      - name: ESLint ìë™ ìˆ˜ì •
        run: npm run lint -- --fix

      - name: Prettier í¬ë§· ê²€ì‚¬
        run: npm run format:check

      - name: Prettier ìë™ í¬ë§·íŒ…
        run: npm run format

      - name: TypeScript íƒ€ì… ì²´í¬
        run: npx tsc --noEmit

      - name: Expo Doctor ì²´í¬
        run: npx expo-doctor

      - name: ì˜ì¡´ì„± í˜¸í™˜ì„± ê²€ì‚¬
        run: npm audit --audit-level=moderate

  build:
    name: EAS Build ì‹¤í–‰
    needs: quality-check
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/production') ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'production')

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Expo ì„¤ì •
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ë¹Œë“œ ì „ ì‘ì—… ì‹¤í–‰
        run: |
          chmod +x scripts/prebuild.sh
          ./scripts/prebuild.sh

      - name: EAS Build ì‹¤í–‰
        run: |
          if [ "${{ github.ref }}" == "refs/heads/production" ]; then
            # í”„ë¡œë•ì…˜ ë¸Œëœì¹˜: í”„ë¡œë•ì…˜ ë¹Œë“œ
            eas build --platform android --profile production --non-interactive
            echo "ğŸš€ í”„ë¡œë•ì…˜ ë¹Œë“œ ì™„ë£Œ (${{ github.ref }} ë¸Œëœì¹˜)"
          else
            # PR ë¨¸ì§€: í”„ë¦¬ë·° ë¹Œë“œ
            eas build --platform android --profile preview --non-interactive
            echo "ğŸ“ í’€ ë¦¬í€˜ìŠ¤íŠ¸ ë¹Œë“œ ì™„ë£Œ"
          fi

      - name: ë¹Œë“œ í›„ ì‘ì—… ì‹¤í–‰
        run: |
          chmod +x scripts/postbuild.sh
          ./scripts/postbuild.sh
